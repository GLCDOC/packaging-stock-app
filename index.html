<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Packaging Stock Management</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      // Initialize Supabase client
      const SUPABASE_URL = 'https://zsskdgkqlcuwwarlqwsz.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpzc2tkZ2txbGN1d3dhcmxxd3N6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MDQ3NzIsImV4cCI6MjA4Mzk4MDc3Mn0.BkrK1Hbg2K5Q6D_UxI9BBAF-g1W6bvgdxhUEiv205uA';
      const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const PackagingStockApp = () => {
          const [currentUser, setCurrentUser] = useState(null);
          const [users, setUsers] = useState([]); // Users loaded from Supabase
          const [pinInput, setPinInput] = useState('');
          const [products, setProducts] = useState([]);
          const [orders, setOrders] = useState([]);
          const [movements, setMovements] = useState([]);
          const [activeTab, setActiveTab] = useState('stock');
          const [showAddProduct, setShowAddProduct] = useState(false);
          const [showEditProduct, setShowEditProduct] = useState(false);
          const [showStockMovement, setShowStockMovement] = useState(false);
          const [showOrderForm, setShowOrderForm] = useState(false);
          const [showPartialReceive, setShowPartialReceive] = useState(false);
          const [selectedOrderItem, setSelectedOrderItem] = useState(null);
          const [selectedProduct, setSelectedProduct] = useState(null);
          const [movementType, setMovementType] = useState('in');
          const [movementQty, setMovementQty] = useState('');
          const [movementNotes, setMovementNotes] = useState('');

          // Load data from Supabase on mount
          useEffect(() => {
              loadAllData();
          }, []);

          const loadAllData = async () => {
              try {
                  // Load products
                  const { data: productsData } = await supabase
                      .from('products')
                      .select('*')
                      .order('created_at', { ascending: false });
                  if (productsData) setProducts(productsData);

                  // Load orders
                  const { data: ordersData } = await supabase
                      .from('orders')
                      .select('*')
                      .order('created_at', { ascending: false });
                  if (ordersData) setOrders(ordersData);

                  // Load movements
                  const { data: movementsData } = await supabase
                      .from('movements')
                      .select('*')
                      .order('timestamp', { ascending: false });
                  if (movementsData) setMovements(movementsData);

                  // Load users from Supabase
                  const { data: usersData } = await supabase
                      .from('users')
                      .select('*');
                  if (usersData) {
                      setUsers(usersData);
                  }
              } catch (error) {
                  console.error('Error loading data:', error);
              }
          };

          const handlePinSubmit = (e) => {
              e.preventDefault();
              const user = users.find(u => u.pin === pinInput);
              if (user) {
                  setCurrentUser(user);
                  setPinInput('');
              } else {
                  alert('Invalid PIN');
                  setPinInput('');
              }
          };

          const handleLogout = () => {
              setCurrentUser(null);
              setActiveTab('stock');
          };

          const addProduct = async (productData) => {
              const newProduct = {
                  ...productData,
                  current_stock: 0,
                  created_by: currentUser.name,
                  created_at: new Date().toISOString()
              };

              const { data, error } = await supabase
                  .from('products')
                  .insert([newProduct])
                  .select();

              if (data && data.length > 0) {
                  setProducts([data[0], ...products]);
              }
              setShowAddProduct(false);
          };

          const updateProduct = async (productData) => {
              const { data, error } = await supabase
                  .from('products')
                  .update(productData)
                  .eq('id', selectedProduct.id)
                  .select();

              if (data && data.length > 0) {
                  setProducts(products.map(p => p.id === selectedProduct.id ? data[0] : p));
              }
              setShowEditProduct(false);
              setSelectedProduct(null);
          };

          const deleteProduct = async (product) => {
              if (!confirm(`Are you sure you want to delete "${product.in_house_name || product.inHouseName}"?`)) {
                  return;
              }

              const { error } = await supabase
                  .from('products')
                  .delete()
                  .eq('id', product.id);

              if (!error) {
                  setProducts(products.filter(p => p.id !== product.id));
              }
          };

          const recordMovement = async () => {
              if (!selectedProduct || !movementQty) return;

              const qty = parseInt(movementQty);
              const movement = {
                  product_id: selectedProduct.id,
                  product_code: selectedProduct.product_code || selectedProduct.productCode,
                  product_name: selectedProduct.in_house_name || selectedProduct.inHouseName,
                  type: movementType,
                  quantity: qty,
                  user_name: currentUser.name,
                  notes: movementNotes,
                  timestamp: new Date().toISOString()
              };

              // Insert movement
              const { data: movementData } = await supabase
                  .from('movements')
                  .insert([movement])
                  .select();

              if (movementData && movementData.length > 0) {
                  setMovements([movementData[0], ...movements]);
              }

              // Update product stock
              const newStock = movementType === 'in'
                  ? selectedProduct.current_stock + qty
                  : Math.max(0, selectedProduct.current_stock - qty);

              await supabase
                  .from('products')
                  .update({ current_stock: newStock })
                  .eq('id', selectedProduct.id);

              setProducts(products.map(p => {
                  if (p.id === selectedProduct.id) {
                      return { ...p, current_stock: newStock };
                  }
                  return p;
              }));

              setShowStockMovement(false);
              setSelectedProduct(null);
              setMovementQty('');
              setMovementNotes('');
          };

          const createOrder = async (orderData) => {
              const newOrder = {
                  supplier: orderData.supplier,
                  expected_date: orderData.expectedDate,
                  notes: orderData.notes,
                  status: 'pending',
                  created_by: currentUser.name,
                  created_at: new Date().toISOString(),
                  items: orderData.items.map(item => ({
                      ...item,
                      received: false,
                      received_qty: 0
                  }))
              };

              const { data, error } = await supabase
                  .from('orders')
                  .insert([newOrder])
                  .select();

              if (data && data.length > 0) {
                  setOrders([data[0], ...orders]);
              }
              setShowOrderForm(false);
          };

          const receiveOrderItem = async (orderId, itemIndex, quantityToReceive) => {
              const order = orders.find(o => o.id === orderId);
              if (!order) return;

              const updatedItems = [...order.items];
              const item = updatedItems[itemIndex];

              // Initialize received_qty if not present
              if (item.received_qty === undefined) {
                  item.received_qty = 0;
              }

              const qtyToReceive = parseInt(quantityToReceive);
              const totalOrdered = parseInt(item.quantity);
              const newReceivedQty = item.received_qty + qtyToReceive;

              // Update received quantity
              item.received_qty = Math.min(newReceivedQty, totalOrdered);

              // Mark as fully received if all quantity is received
              if (item.received_qty >= totalOrdered) {
                  item.received = true;
              }

              // Add received history entry
              if (!item.received_history) {
                  item.received_history = [];
              }
              item.received_history.push({
                  date: new Date().toISOString(),
                  by: currentUser.name,
                  quantity: qtyToReceive
              });

              const product = products.find(p =>
                  (p.product_code || p.productCode) === (item.productCode || item.product_code)
              );

              if (product) {
                  const newStock = product.current_stock + qtyToReceive;

                  // Update product stock
                  await supabase
                      .from('products')
                      .update({ current_stock: newStock })
                      .eq('id', product.id);

                  setProducts(products.map(p =>
                      p.id === product.id ? { ...p, current_stock: newStock } : p
                  ));

                  // Record movement
                  const movement = {
                      product_id: product.id,
                      product_code: product.product_code || product.productCode,
                      product_name: product.in_house_name || product.inHouseName,
                      type: 'in',
                      quantity: qtyToReceive,
                      user_name: currentUser.name,
                      notes: `Order #${orderId} - Received ${qtyToReceive} of ${totalOrdered}`,
                      timestamp: new Date().toISOString()
                  };

                  const { data: movementData } = await supabase
                      .from('movements')
                      .insert([movement])
                      .select();

                  if (movementData && movementData.length > 0) {
                      setMovements([movementData[0], ...movements]);
                  }
              }

              const allReceived = updatedItems.every(i => i.received);
              const anyReceived = updatedItems.some(i => i.received_qty > 0);
              const newStatus = allReceived ? 'completed' : (anyReceived ? 'partial' : 'pending');

              // Update order
              await supabase
                  .from('orders')
                  .update({ items: updatedItems, status: newStatus })
                  .eq('id', orderId);

              setOrders(orders.map(o =>
                  o.id === orderId ? { ...o, items: updatedItems, status: newStatus } : o
              ));
          };

          if (!currentUser) {
              return (
                  <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                      <div className="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md">
                          <div className="text-center mb-8">
                              <div className="w-16 h-16 bg-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4">
                                  <svg className="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                                  </svg>
                              </div>
                              <h1 className="text-3xl font-bold text-gray-800">Packaging Stock</h1>
                              <p className="text-gray-600 mt-2">Enter your PIN to continue</p>
                          </div>
                          <form onSubmit={handlePinSubmit}>
                              <input
                                  type="password"
                                  value={pinInput}
                                  onChange={(e) => setPinInput(e.target.value)}
                                  placeholder="Enter 4-digit PIN"
                                  maxLength="4"
                                  className="w-full p-4 text-center text-2xl border-2 border-gray-300 rounded-lg focus:border-indigo-600 focus:outline-none"
                                  autoFocus
                              />
                              <button
                                  type="submit"
                                  className="w-full mt-4 bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition"
                              >
                                  Login
                              </button>
                          </form>
                      </div>
                  </div>
              );
          }

          return (
              <div className="min-h-screen bg-gray-50">
                  <div className="bg-indigo-600 text-white shadow-lg">
                      <div className="container mx-auto px-4 py-4">
                          <div className="flex justify-between items-center">
                              <div className="flex items-center gap-3">
                                  <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                                  </svg>
                                  <h1 className="text-2xl font-bold">Packaging Stock Management</h1>
                              </div>
                              <div className="flex items-center gap-4">
                                  <span className="text-sm">Welcome, {currentUser.name}</span>
                                  <button
                                      onClick={handleLogout}
                                      className="flex items-center gap-2 bg-indigo-700 px-4 py-2 rounded-lg hover:bg-indigo-800 transition"
                                  >
                                      Logout
                                  </button>
                              </div>
                          </div>
                      </div>
                  </div>

                  <div className="bg-white border-b">
                      <div className="container mx-auto px-4">
                          <div className="flex gap-1">
                              {['stock', 'orders', 'movements', 'usage'].map(tab => (
                                  <button
                                      key={tab}
                                      onClick={() => setActiveTab(tab)}
                                      className={`px-6 py-3 font-semibold capitalize transition ${
                                          activeTab === tab
                                              ? 'border-b-2 border-indigo-600 text-indigo-600'
                                              : 'text-gray-600 hover:text-gray-800'
                                      }`}
                                  >
                                      {tab}
                                  </button>
                              ))}
                          </div>
                      </div>
                  </div>

                  <div className="container mx-auto px-4 py-6">
                      {activeTab === 'stock' && (
                          <StockView
                              products={products}
                              onAddProduct={() => setShowAddProduct(true)}
                              onEditProduct={(product) => {
                                  setSelectedProduct(product);
                                  setShowEditProduct(true);
                              }}
                              onDeleteProduct={deleteProduct}
                              onStockIn={(product) => {
                                  setSelectedProduct(product);
                                  setMovementType('in');
                                  setShowStockMovement(true);
                              }}
                              onStockOut={(product) => {
                                  setSelectedProduct(product);
                                  setMovementType('out');
                                  setShowStockMovement(true);
                              }}
                          />
                      )}

                      {activeTab === 'orders' && (
                          <OrdersView
                              orders={orders}
                              onCreateOrder={() => setShowOrderForm(true)}
                              onReceiveItem={(orderId, itemIndex, item) => {
                                  setSelectedOrderItem({ orderId, itemIndex, item });
                                  setShowPartialReceive(true);
                              }}
                          />
                      )}

                      {activeTab === 'movements' && (
                          <MovementsView movements={movements} />
                      )}

                      {activeTab === 'usage' && (
                          <UsageView movements={movements} products={products} />
                      )}
                  </div>

                  {showAddProduct && (
                      <AddProductModal
                          onClose={() => setShowAddProduct(false)}
                          onAdd={addProduct}
                      />
                  )}

                  {showEditProduct && selectedProduct && (
                      <EditProductModal
                          product={selectedProduct}
                          onClose={() => {
                              setShowEditProduct(false);
                              setSelectedProduct(null);
                          }}
                          onUpdate={updateProduct}
                          onDelete={() => {
                              deleteProduct(selectedProduct);
                              setShowEditProduct(false);
                              setSelectedProduct(null);
                          }}
                      />
                  )}

                  {showStockMovement && (
                      <StockMovementModal
                          product={selectedProduct}
                          type={movementType}
                          quantity={movementQty}
                          notes={movementNotes}
                          onQuantityChange={setMovementQty}
                          onNotesChange={setMovementNotes}
                          onClose={() => {
                              setShowStockMovement(false);
                              setSelectedProduct(null);
                              setMovementQty('');
                              setMovementNotes('');
                          }}
                          onSubmit={recordMovement}
                      />
                  )}

                  {showOrderForm && (
                      <OrderFormModal
                          products={products}
                          onClose={() => setShowOrderForm(false)}
                          onSubmit={createOrder}
                      />
                  )}

                  {showPartialReceive && selectedOrderItem && (
                      <PartialReceiveModal
                          orderItem={selectedOrderItem}
                          onClose={() => {
                              setShowPartialReceive(false);
                              setSelectedOrderItem(null);
                          }}
                          onSubmit={(quantity) => {
                              receiveOrderItem(selectedOrderItem.orderId, selectedOrderItem.itemIndex, quantity);
                              setShowPartialReceive(false);
                              setSelectedOrderItem(null);
                          }}
                      />
                  )}
              </div>
          );
      };

      const StockView = ({ products, onAddProduct, onEditProduct, onDeleteProduct, onStockIn, onStockOut }) => {
          const [searchTerm, setSearchTerm] = useState('');
          const [filterLowStock, setFilterLowStock] = useState(false);

          const filteredProducts = products.filter(p => {
              const productCode = p.product_code || p.productCode || '';
              const inHouseName = p.in_house_name || p.inHouseName || '';
              const productName = p.product_name || p.productName || '';
              const matchesSearch = productCode.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                   inHouseName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                   productName.toLowerCase().includes(searchTerm.toLowerCase());
              const currentStock = p.current_stock !== undefined ? p.current_stock : p.currentStock;
              const threshold = p.low_stock_threshold !== undefined ? p.low_stock_threshold : p.lowStockThreshold;
              const matchesFilter = !filterLowStock || currentStock <= threshold;
              return matchesSearch && matchesFilter;
          });

          const lowStockCount = products.filter(p => {
              const currentStock = p.current_stock !== undefined ? p.current_stock : p.currentStock;
              const threshold = p.low_stock_threshold !== undefined ? p.low_stock_threshold : p.lowStockThreshold;
              return currentStock <= threshold;
          }).length;

          return (
              <div>
                  <div className="flex justify-between items-center mb-6 flex-wrap gap-4">
                      <div className="flex gap-4 items-center flex-wrap">
                          <input
                              type="text"
                              placeholder="Search products..."
                              value={searchTerm}
                              onChange={(e) => setSearchTerm(e.target.value)}
                              className="px-4 py-2 border rounded-lg w-64"
                          />
                          <label className="flex items-center gap-2 cursor-pointer">
                              <input
                                  type="checkbox"
                                  checked={filterLowStock}
                                  onChange={(e) => setFilterLowStock(e.target.checked)}
                                  className="w-4 h-4"
                              />
                              <span className="text-sm">Low Stock Only</span>
                              {lowStockCount > 0 && (
                                  <span className="bg-red-100 text-red-700 px-2 py-1 rounded-full text-xs font-semibold">
                                      {lowStockCount}
                                  </span>
                              )}
                          </label>
                      </div>
                      <button
                          onClick={onAddProduct}
                          className="flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition"
                      >
                          <span>+</span> Add Product
                      </button>
                  </div>

                  <div className="bg-white rounded-lg shadow overflow-x-auto">
                      <table className="w-full">
                          <thead className="bg-gray-50 border-b">
                              <tr>
                                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Code</th>
                                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">In House Name</th>
                                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Size</th>
                                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Pack Size</th>
                                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Current Stock</th>
                                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Status</th>
                                  <th className="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">Actions</th>
                              </tr>
                          </thead>
                          <tbody className="divide-y">
                              {filteredProducts.map(product => {
                                  const currentStock = product.current_stock !== undefined ? product.current_stock : product.currentStock;
                                  const threshold = product.low_stock_threshold !== undefined ? product.low_stock_threshold : product.lowStockThreshold;
                                  return (
                                  <tr key={product.id} className="hover:bg-gray-50">
                                      <td className="px-4 py-3 text-sm font-medium">{product.product_code || product.productCode}</td>
                                      <td className="px-4 py-3 text-sm">{product.in_house_name || product.inHouseName}</td>
                                      <td className="px-4 py-3 text-sm text-gray-600">{product.size || '-'}</td>
                                      <td className="px-4 py-3 text-sm text-gray-600">{product.online_pack_size || product.onlinePackSize || '-'}</td>
                                      <td className="px-4 py-3 text-sm font-semibold">{currentStock}</td>
                                      <td className="px-4 py-3">
                                          {currentStock <= threshold ? (
                                              <span className="flex items-center gap-1 text-red-600 text-sm">
                                                  ‚ö† Low Stock
                                              </span>
                                          ) : (
                                              <span className="text-green-600 text-sm">‚úì OK</span>
                                          )}
                                      </td>
                                      <td className="px-4 py-3 text-right">
                                          <div className="flex justify-end items-center gap-2">
                                              <button
                                                  onClick={() => onEditProduct(product)}
                                                  className="bg-gray-100 text-gray-600 px-3 py-1 rounded hover:bg-gray-200 transition text-sm"
                                                  title="Edit product"
                                              >
                                                  Edit
                                              </button>
                                              <span className="border-l border-gray-300 h-6 mx-1"></span>
                                              <button
                                                  onClick={() => onStockIn(product)}
                                                  className="bg-green-100 text-green-700 px-3 py-1 rounded hover:bg-green-200 transition text-sm"
                                              >
                                                  + In
                                              </button>
                                              <button
                                                  onClick={() => onStockOut(product)}
                                                  className="bg-red-100 text-red-700 px-3 py-1 rounded hover:bg-red-200 transition text-sm"
                                              >
                                                  - Out
                                              </button>
                                          </div>
                                      </td>
                                  </tr>
                                  );
                              })}
                          </tbody>
                      </table>
                      {filteredProducts.length === 0 && (
                          <div className="text-center py-12 text-gray-500">
                              No products found
                          </div>
                      )}
                  </div>
              </div>
          );
      };

      const OrdersView = ({ orders, onCreateOrder, onReceiveItem }) => {
          const [filterStatus, setFilterStatus] = useState('all');

          const filteredOrders = orders.filter(order => {
              if (filterStatus === 'all') return true;
              return order.status === filterStatus;
          });

          return (
              <div>
                  <div className="flex justify-between items-center mb-6 flex-wrap gap-4">
                      <div className="flex gap-2">
                          {['all', 'pending', 'partial', 'completed'].map(status => (
                              <button
                                  key={status}
                                  onClick={() => setFilterStatus(status)}
                                  className={`px-4 py-2 rounded-lg capitalize transition ${
                                      filterStatus === status
                                          ? 'bg-indigo-600 text-white'
                                          : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                  }`}
                              >
                                  {status}
                              </button>
                          ))}
                      </div>
                      <button
                          onClick={onCreateOrder}
                          className="flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition"
                      >
                          üõí New Order
                      </button>
                  </div>

                  <div className="space-y-4">
                      {filteredOrders.map(order => (
                          <div key={order.id} className="bg-white rounded-lg shadow p-6">
                              <div className="flex justify-between items-start mb-4">
                                  <div>
                                      <h3 className="text-lg font-semibold">Order #{order.id}</h3>
                                      <p className="text-sm text-gray-600">
                                          Created by {order.created_by || order.createdBy} on {new Date(order.created_at || order.createdAt).toLocaleDateString()}
                                      </p>
                                      <p className="text-sm text-gray-600">
                                          Supplier: {order.supplier} | Expected: {new Date(order.expected_date || order.expectedDate).toLocaleDateString()}
                                      </p>
                                  </div>
                                  <span className={`px-3 py-1 rounded-full text-sm font-semibold capitalize ${
                                      order.status === 'completed' ? 'bg-green-100 text-green-700' :
                                      order.status === 'partial' ? 'bg-yellow-100 text-yellow-700' :
                                      'bg-blue-100 text-blue-700'
                                  }`}>
                                      {order.status}
                                  </span>
                              </div>

                              <div className="border-t pt-4 overflow-x-auto">
                                  <table className="w-full">
                                      <thead>
                                          <tr className="text-left text-xs text-gray-600 uppercase">
                                              <th className="pb-2">Product Code</th>
                                              <th className="pb-2">Product Name</th>
                                              <th className="pb-2">Ordered</th>
                                              <th className="pb-2">Received</th>
                                              <th className="pb-2">Status</th>
                                              <th className="pb-2 text-right">Action</th>
                                          </tr>
                                      </thead>
                                      <tbody className="divide-y">
                                          {order.items.map((item, idx) => {
                                              const receivedQty = item.received_qty || 0;
                                              const orderedQty = parseInt(item.quantity);
                                              const remaining = orderedQty - receivedQty;
                                              return (
                                              <tr key={idx}>
                                                  <td className="py-2 text-sm">{item.productCode}</td>
                                                  <td className="py-2 text-sm">{item.productName}</td>
                                                  <td className="py-2 text-sm font-medium">{orderedQty}</td>
                                                  <td className="py-2 text-sm">
                                                      <span className={receivedQty > 0 ? 'font-medium text-green-700' : 'text-gray-400'}>
                                                          {receivedQty}
                                                      </span>
                                                  </td>
                                                  <td className="py-2">
                                                      {item.received ? (
                                                          <span className="text-green-600 text-sm">
                                                              ‚úì Complete
                                                          </span>
                                                      ) : receivedQty > 0 ? (
                                                          <span className="text-yellow-600 text-sm">
                                                              ‚è≥ Partial ({remaining} remaining)
                                                          </span>
                                                      ) : (
                                                          <span className="text-gray-500 text-sm">Pending</span>
                                                      )}
                                                  </td>
                                                  <td className="py-2 text-right">
                                                      {!item.received && (
                                                          <button
                                                              onClick={() => onReceiveItem(order.id, idx, item)}
                                                              className="bg-green-100 text-green-700 px-3 py-1 rounded hover:bg-green-200 transition text-sm"
                                                          >
                                                              Receive
                                                          </button>
                                                      )}
                                                  </td>
                                              </tr>
                                              );
                                          })}
                                      </tbody>
                                  </table>
                              </div>
                          </div>
                      ))}
                  </div>

                  {filteredOrders.length === 0 && (
                      <div className="bg-white rounded-lg shadow p-12 text-center text-gray-500">
                          No orders found
                      </div>
                  )}
              </div>
          );
      };

      const MovementsView = ({ movements }) => {
          const [filterType, setFilterType] = useState('all');

          const filteredMovements = movements.filter(m => {
              if (filterType === 'all') return true;
              return m.type === filterType;
          });

          return (
              <div>
                  <div className="flex gap-2 mb-6">
                      {['all', 'in', 'out'].map(type => (
                          <button
                              key={type}
                              onClick={() => setFilterType(type)}
                              className={`px-4 py-2 rounded-lg capitalize transition ${
                                  filterType === type
                                      ? 'bg-indigo-600 text-white'
                                      : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                              }`}
                          >
                              {type === 'all' ? 'All Movements' : `Stock ${type}`}
                          </button>
                      ))}
                  </div>

                  <div className="bg-white rounded-lg shadow overflow-x-auto">
                      <table className="w-full">
                          <thead className="bg-gray-50 border-b">
                              <tr>
                                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Date/Time</th>
                                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Type</th>
                                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Product</th>
                                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Quantity</th>
                                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">User</th>
                                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Notes</th>
                              </tr>
                          </thead>
                          <tbody className="divide-y">
                              {filteredMovements.map(movement => (
                                  <tr key={movement.id} className="hover:bg-gray-50">
                                      <td className="px-4 py-3 text-sm">
                                          {new Date(movement.timestamp).toLocaleString()}
                                      </td>
                                      <td className="px-4 py-3">
                                          <span className={`px-2 py-1 rounded text-xs font-semibold ${
                                              movement.type === 'in'
                                                  ? 'bg-green-100 text-green-700'
                                                  : 'bg-red-100 text-red-700'
                                          }`}>
                                              {movement.type.toUpperCase()}
                                          </span>
                                      </td>
                                      <td className="px-4 py-3 text-sm">
                                          <div className="font-medium">{movement.product_name || movement.productName}</div>
                                          <div className="text-gray-600 text-xs">{movement.product_code || movement.productCode}</div>
                                      </td>
                                      <td className="px-4 py-3 text-sm font-semibold">{movement.quantity}</td>
                                      <td className="px-4 py-3 text-sm">{movement.user_name || movement.user}</td>
                                      <td className="px-4 py-3 text-sm text-gray-600">{movement.notes || '-'}</td>
                                  </tr>
                              ))}
                          </tbody>
                      </table>
                      {filteredMovements.length === 0 && (
                          <div className="text-center py-12 text-gray-500">
                              No movements recorded
                          </div>
                      )}
                  </div>
              </div>
          );
      };

      const UsageView = ({ movements, products }) => {
          const [dateRange, setDateRange] = useState('3months');
          const [customStart, setCustomStart] = useState('');
          const [customEnd, setCustomEnd] = useState('');
          const barChartRef = useRef(null);
          const lineChartRef = useRef(null);
          const barChartInstance = useRef(null);
          const lineChartInstance = useRef(null);

          // Calculate date range
          const getDateRange = () => {
              const now = new Date();
              const end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
              let start;

              switch (dateRange) {
                  case '1month':
                      start = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                      break;
                  case '3months':
                      start = new Date(now.getFullYear(), now.getMonth() - 3, now.getDate());
                      break;
                  case '6months':
                      start = new Date(now.getFullYear(), now.getMonth() - 6, now.getDate());
                      break;
                  case '12months':
                      start = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
                      break;
                  case 'custom':
                      start = customStart ? new Date(customStart) : new Date(0);
                      return {
                          start,
                          end: customEnd ? new Date(customEnd + 'T23:59:59') : end
                      };
                  default:
                      start = new Date(now.getFullYear(), now.getMonth() - 3, now.getDate());
              }
              return { start, end };
          };

          const { start: rangeStart, end: rangeEnd } = getDateRange();

          // Filter movements to only OUT movements within date range
          const usageMovements = movements.filter(m => {
              if (m.type !== 'out') return false;
              const moveDate = new Date(m.timestamp);
              return moveDate >= rangeStart && moveDate <= rangeEnd;
          });

          // Calculate usage by product
          const usageByProduct = usageMovements.reduce((acc, m) => {
              const productName = m.product_name || m.productName;
              const productCode = m.product_code || m.productCode;
              const key = productCode;

              if (!acc[key]) {
                  acc[key] = {
                      productName,
                      productCode,
                      totalUsage: 0,
                      movements: []
                  };
              }
              acc[key].totalUsage += m.quantity;
              acc[key].movements.push(m);
              return acc;
          }, {});

          const usageList = Object.values(usageByProduct).sort((a, b) => b.totalUsage - a.totalUsage);
          const totalUsage = usageList.reduce((sum, item) => sum + item.totalUsage, 0);

          // Calculate days in range for daily average
          const daysInRange = Math.max(1, Math.ceil((rangeEnd - rangeStart) / (1000 * 60 * 60 * 24)));

          // Calculate usage over time (weekly buckets)
          const getUsageOverTime = () => {
              const weeklyData = {};
              usageMovements.forEach(m => {
                  const date = new Date(m.timestamp);
                  // Get start of week (Monday)
                  const day = date.getDay();
                  const diff = date.getDate() - day + (day === 0 ? -6 : 1);
                  const weekStart = new Date(date.setDate(diff));
                  const weekKey = weekStart.toISOString().split('T')[0];

                  if (!weeklyData[weekKey]) {
                      weeklyData[weekKey] = 0;
                  }
                  weeklyData[weekKey] += m.quantity;
              });

              // Sort by date and return
              const sortedWeeks = Object.keys(weeklyData).sort();
              return {
                  labels: sortedWeeks.map(w => {
                      const date = new Date(w);
                      return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
                  }),
                  data: sortedWeeks.map(w => weeklyData[w])
              };
          };

          const timeData = getUsageOverTime();

          // Chart colors
          const chartColors = [
              'rgba(99, 102, 241, 0.8)',   // indigo
              'rgba(34, 197, 94, 0.8)',    // green
              'rgba(249, 115, 22, 0.8)',   // orange
              'rgba(236, 72, 153, 0.8)',   // pink
              'rgba(14, 165, 233, 0.8)',   // sky
              'rgba(168, 85, 247, 0.8)',   // purple
              'rgba(234, 179, 8, 0.8)',    // yellow
              'rgba(239, 68, 68, 0.8)',    // red
          ];

          // Update charts when data changes
          useEffect(() => {
              // Bar Chart - Usage by Product
              if (barChartRef.current && usageList.length > 0) {
                  if (barChartInstance.current) {
                      barChartInstance.current.destroy();
                  }

                  barChartInstance.current = new Chart(barChartRef.current, {
                      type: 'bar',
                      data: {
                          labels: usageList.map(item => item.productName),
                          datasets: [{
                              label: 'Total Usage',
                              data: usageList.map(item => item.totalUsage),
                              backgroundColor: chartColors.slice(0, usageList.length),
                              borderRadius: 6,
                          }]
                      },
                      options: {
                          responsive: true,
                          maintainAspectRatio: false,
                          plugins: {
                              legend: { display: false },
                              title: {
                                  display: true,
                                  text: 'Usage by Product',
                                  font: { size: 16, weight: 'bold' }
                              }
                          },
                          scales: {
                              y: {
                                  beginAtZero: true,
                                  ticks: { precision: 0 }
                              }
                          }
                      }
                  });
              }

              // Line Chart - Usage Over Time
              if (lineChartRef.current && timeData.labels.length > 0) {
                  if (lineChartInstance.current) {
                      lineChartInstance.current.destroy();
                  }

                  lineChartInstance.current = new Chart(lineChartRef.current, {
                      type: 'line',
                      data: {
                          labels: timeData.labels,
                          datasets: [{
                              label: 'Weekly Usage',
                              data: timeData.data,
                              borderColor: 'rgba(99, 102, 241, 1)',
                              backgroundColor: 'rgba(99, 102, 241, 0.1)',
                              fill: true,
                              tension: 0.3,
                              pointRadius: 4,
                              pointHoverRadius: 6,
                          }]
                      },
                      options: {
                          responsive: true,
                          maintainAspectRatio: false,
                          plugins: {
                              legend: { display: false },
                              title: {
                                  display: true,
                                  text: 'Usage Over Time (Weekly)',
                                  font: { size: 16, weight: 'bold' }
                              }
                          },
                          scales: {
                              y: {
                                  beginAtZero: true,
                                  ticks: { precision: 0 }
                              }
                          }
                      }
                  });
              }

              // Cleanup on unmount
              return () => {
                  if (barChartInstance.current) barChartInstance.current.destroy();
                  if (lineChartInstance.current) lineChartInstance.current.destroy();
              };
          }, [usageList, timeData, dateRange, customStart, customEnd]);

          const dateRangeOptions = [
              { value: '1month', label: '1 Month' },
              { value: '3months', label: '3 Months' },
              { value: '6months', label: '6 Months' },
              { value: '12months', label: '12 Months' },
              { value: 'custom', label: 'Custom Range' }
          ];

          return (
              <div>
                  <div className="mb-6">
                      <div className="flex flex-wrap gap-2 mb-4">
                          {dateRangeOptions.map(option => (
                              <button
                                  key={option.value}
                                  onClick={() => setDateRange(option.value)}
                                  className={`px-4 py-2 rounded-lg transition ${
                                      dateRange === option.value
                                          ? 'bg-indigo-600 text-white'
                                          : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                  }`}
                              >
                                  {option.label}
                              </button>
                          ))}
                      </div>

                      {dateRange === 'custom' && (
                          <div className="flex flex-wrap gap-4 p-4 bg-gray-100 rounded-lg">
                              <div>
                                  <label className="block text-sm font-medium mb-1">Start Date</label>
                                  <input
                                      type="date"
                                      value={customStart}
                                      onChange={(e) => setCustomStart(e.target.value)}
                                      className="p-2 border rounded"
                                  />
                              </div>
                              <div>
                                  <label className="block text-sm font-medium mb-1">End Date</label>
                                  <input
                                      type="date"
                                      value={customEnd}
                                      onChange={(e) => setCustomEnd(e.target.value)}
                                      className="p-2 border rounded"
                                  />
                              </div>
                          </div>
                      )}
                  </div>

                  {/* Summary Cards */}
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                      <div className="bg-white rounded-lg shadow p-6">
                          <div className="text-sm text-gray-600 mb-1">Total Usage</div>
                          <div className="text-3xl font-bold text-indigo-600">{totalUsage.toLocaleString()}</div>
                          <div className="text-xs text-gray-500 mt-1">items used</div>
                      </div>
                      <div className="bg-white rounded-lg shadow p-6">
                          <div className="text-sm text-gray-600 mb-1">Daily Average</div>
                          <div className="text-3xl font-bold text-green-600">{Math.round(totalUsage / daysInRange).toLocaleString()}</div>
                          <div className="text-xs text-gray-500 mt-1">items per day</div>
                      </div>
                      <div className="bg-white rounded-lg shadow p-6">
                          <div className="text-sm text-gray-600 mb-1">Period</div>
                          <div className="text-lg font-bold text-gray-700">{daysInRange} days</div>
                          <div className="text-xs text-gray-500 mt-1">
                              {rangeStart.toLocaleDateString()} - {rangeEnd.toLocaleDateString()}
                          </div>
                      </div>
                  </div>

                  {/* Charts */}
                  {usageList.length > 0 && (
                      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                          <div className="bg-white rounded-lg shadow p-6">
                              <div style={{ height: '300px' }}>
                                  <canvas ref={barChartRef}></canvas>
                              </div>
                          </div>
                          <div className="bg-white rounded-lg shadow p-6">
                              <div style={{ height: '300px' }}>
                                  <canvas ref={lineChartRef}></canvas>
                              </div>
                          </div>
                      </div>
                  )}

                  {/* Usage by Product Table */}
                  <div className="bg-white rounded-lg shadow overflow-x-auto">
                      <div className="p-4 border-b">
                          <h3 className="font-semibold text-lg">Usage by Product</h3>
                      </div>
                      <table className="w-full">
                          <thead className="bg-gray-50 border-b">
                              <tr>
                                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Product</th>
                                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Code</th>
                                  <th className="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">Total Used</th>
                                  <th className="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">Daily Avg</th>
                                  <th className="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">% of Total</th>
                                  <th className="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">Transactions</th>
                              </tr>
                          </thead>
                          <tbody className="divide-y">
                              {usageList.map(item => {
                                  const percentage = totalUsage > 0 ? ((item.totalUsage / totalUsage) * 100).toFixed(1) : 0;
                                  const dailyAvg = Math.round(item.totalUsage / daysInRange);
                                  return (
                                      <tr key={item.productCode} className="hover:bg-gray-50">
                                          <td className="px-4 py-3 text-sm font-medium">{item.productName}</td>
                                          <td className="px-4 py-3 text-sm text-gray-600">{item.productCode}</td>
                                          <td className="px-4 py-3 text-sm font-semibold text-right">{item.totalUsage.toLocaleString()}</td>
                                          <td className="px-4 py-3 text-sm text-right">{dailyAvg.toLocaleString()}</td>
                                          <td className="px-4 py-3 text-right">
                                              <div className="flex items-center justify-end gap-2">
                                                  <div className="w-16 bg-gray-200 rounded-full h-2">
                                                      <div
                                                          className="bg-indigo-600 h-2 rounded-full"
                                                          style={{ width: `${percentage}%` }}
                                                      ></div>
                                                  </div>
                                                  <span className="text-sm">{percentage}%</span>
                                              </div>
                                          </td>
                                          <td className="px-4 py-3 text-sm text-gray-600 text-right">{item.movements.length}</td>
                                      </tr>
                                  );
                              })}
                          </tbody>
                          {usageList.length > 0 && (
                              <tfoot className="bg-gray-50 border-t font-semibold">
                                  <tr>
                                      <td className="px-4 py-3 text-sm">Total</td>
                                      <td className="px-4 py-3"></td>
                                      <td className="px-4 py-3 text-sm text-right">{totalUsage.toLocaleString()}</td>
                                      <td className="px-4 py-3 text-sm text-right">{Math.round(totalUsage / daysInRange).toLocaleString()}</td>
                                      <td className="px-4 py-3 text-sm text-right">100%</td>
                                      <td className="px-4 py-3 text-sm text-gray-600 text-right">{usageMovements.length}</td>
                                  </tr>
                              </tfoot>
                          )}
                      </table>
                      {usageList.length === 0 && (
                          <div className="text-center py-12 text-gray-500">
                              No usage data for selected period
                          </div>
                      )}
                  </div>
              </div>
          );
      };

      const AddProductModal = ({ onClose, onAdd }) => {
          const [formData, setFormData] = useState({
              product_code: '',
              size: '',
              in_house_name: '',
              product_name: '',
              online_pack_size: '',
              received_pack_size: '',
              supplier: 'MacFarlane',
              low_stock_threshold: 10
          });

          const handleSubmit = (e) => {
              e.preventDefault();
              onAdd(formData);
          };

          return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                  <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                      <div className="p-6 border-b flex justify-between items-center sticky top-0 bg-white">
                          <h2 className="text-xl font-bold">Add New Product</h2>
                          <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                      </div>
                      <form onSubmit={handleSubmit} className="p-6 space-y-4">
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                              <div>
                                  <label className="block text-sm font-medium mb-1">Product Code *</label>
                                  <input
                                      type="text"
                                      required
                                      value={formData.product_code}
                                      onChange={(e) => setFormData({...formData, product_code: e.target.value})}
                                      className="w-full p-2 border rounded"
                                  />
                              </div>
                              <div>
                                  <label className="block text-sm font-medium mb-1">Size</label>
                                  <input
                                      type="text"
                                      value={formData.size}
                                      onChange={(e) => setFormData({...formData, size: e.target.value})}
                                      className="w-full p-2 border rounded"
                                  />
                              </div>
                              <div>
                                  <label className="block text-sm font-medium mb-1">In House Name *</label>
                                  <input
                                      type="text"
                                      required
                                      value={formData.in_house_name}
                                      onChange={(e) => setFormData({...formData, in_house_name: e.target.value})}
                                      className="w-full p-2 border rounded"
                                  />
                              </div>
                              <div>
                                  <label className="block text-sm font-medium mb-1">Product Name *</label>
                                  <input
                                      type="text"
                                      required
                                      value={formData.product_name}
                                      onChange={(e) => setFormData({...formData, product_name: e.target.value})}
                                      className="w-full p-2 border rounded"
                                  />
                              </div>
                              <div>
                                  <label className="block text-sm font-medium mb-1">Online Pack Size</label>
                                  <input
                                      type="text"
                                      value={formData.online_pack_size}
                                      onChange={(e) => setFormData({...formData, online_pack_size: e.target.value})}
                                      className="w-full p-2 border rounded"
                                  />
                              </div>
                              <div>
                                  <label className="block text-sm font-medium mb-1">Received Pack Size</label>
                                  <input
                                      type="text"
                                      value={formData.received_pack_size}
                                      onChange={(e) => setFormData({...formData, received_pack_size: e.target.value})}
                                      className="w-full p-2 border rounded"
                                  />
                              </div>
                              <div>
                                  <label className="block text-sm font-medium mb-1">Supplier</label>
                                  <input
                                      type="text"
                                      value={formData.supplier}
                                      onChange={(e) => setFormData({...formData, supplier: e.target.value})}
                                      className="w-full p-2 border rounded"
                                  />
                              </div>
                              <div>
                                  <label className="block text-sm font-medium mb-1">Low Stock Threshold</label>
                                  <input
                                      type="number"
                                      value={formData.low_stock_threshold}
                                      onChange={(e) => setFormData({...formData, low_stock_threshold: e.target.value})}
                                      className="w-full p-2 border rounded"
                                  />
                              </div>
                          </div>
                          <div className="flex justify-end gap-2 pt-4">
                              <button
                                  type="button"
                                  onClick={onClose}
                                  className="px-4 py-2 border rounded-lg hover:bg-gray-50 transition"
                              >
                                  Cancel
                              </button>
                              <button
                                  type="submit"
                                  className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition"
                              >
                                  Add Product
                              </button>
                          </div>
                      </form>
                  </div>
              </div>
          );
      };

      const EditProductModal = ({ product, onClose, onUpdate, onDelete }) => {
          const [formData, setFormData] = useState({
              product_code: product.product_code || product.productCode || '',
              size: product.size || '',
              in_house_name: product.in_house_name || product.inHouseName || '',
              product_name: product.product_name || product.productName || '',
              online_pack_size: product.online_pack_size || product.onlinePackSize || '',
              received_pack_size: product.received_pack_size || product.receivedPackSize || '',
              supplier: product.supplier || 'MacFarlane',
              low_stock_threshold: product.low_stock_threshold !== undefined ? product.low_stock_threshold : product.lowStockThreshold || 10
          });

          const handleSubmit = (e) => {
              e.preventDefault();
              onUpdate(formData);
          };

          return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                  <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                      <div className="p-6 border-b flex justify-between items-center sticky top-0 bg-white">
                          <h2 className="text-xl font-bold">Edit Product</h2>
                          <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                      </div>
                      <form onSubmit={handleSubmit} className="p-6 space-y-4">
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                              <div>
                                  <label className="block text-sm font-medium mb-1">Product Code *</label>
                                  <input
                                      type="text"
                                      required
                                      value={formData.product_code}
                                      onChange={(e) => setFormData({...formData, product_code: e.target.value})}
                                      className="w-full p-2 border rounded"
                                  />
                              </div>
                              <div>
                                  <label className="block text-sm font-medium mb-1">Size</label>
                                  <input
                                      type="text"
                                      value={formData.size}
                                      onChange={(e) => setFormData({...formData, size: e.target.value})}
                                      className="w-full p-2 border rounded"
                                  />
                              </div>
                              <div>
                                  <label className="block text-sm font-medium mb-1">In House Name *</label>
                                  <input
                                      type="text"
                                      required
                                      value={formData.in_house_name}
                                      onChange={(e) => setFormData({...formData, in_house_name: e.target.value})}
                                      className="w-full p-2 border rounded"
                                  />
                              </div>
                              <div>
                                  <label className="block text-sm font-medium mb-1">Product Name *</label>
                                  <input
                                      type="text"
                                      required
                                      value={formData.product_name}
                                      onChange={(e) => setFormData({...formData, product_name: e.target.value})}
                                      className="w-full p-2 border rounded"
                                  />
                              </div>
                              <div>
                                  <label className="block text-sm font-medium mb-1">Online Pack Size</label>
                                  <input
                                      type="text"
                                      value={formData.online_pack_size}
                                      onChange={(e) => setFormData({...formData, online_pack_size: e.target.value})}
                                      className="w-full p-2 border rounded"
                                  />
                              </div>
                              <div>
                                  <label className="block text-sm font-medium mb-1">Received Pack Size</label>
                                  <input
                                      type="text"
                                      value={formData.received_pack_size}
                                      onChange={(e) => setFormData({...formData, received_pack_size: e.target.value})}
                                      className="w-full p-2 border rounded"
                                  />
                              </div>
                              <div>
                                  <label className="block text-sm font-medium mb-1">Supplier</label>
                                  <input
                                      type="text"
                                      value={formData.supplier}
                                      onChange={(e) => setFormData({...formData, supplier: e.target.value})}
                                      className="w-full p-2 border rounded"
                                  />
                              </div>
                              <div>
                                  <label className="block text-sm font-medium mb-1">Low Stock Threshold</label>
                                  <input
                                      type="number"
                                      value={formData.low_stock_threshold}
                                      onChange={(e) => setFormData({...formData, low_stock_threshold: e.target.value})}
                                      className="w-full p-2 border rounded"
                                  />
                              </div>
                          </div>
                          <div className="flex justify-between pt-4 border-t mt-6">
                              <button
                                  type="button"
                                  onClick={onDelete}
                                  className="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition"
                              >
                                  Delete Product
                              </button>
                              <div className="flex gap-2">
                                  <button
                                      type="button"
                                      onClick={onClose}
                                      className="px-4 py-2 border rounded-lg hover:bg-gray-50 transition"
                                  >
                                      Cancel
                                  </button>
                                  <button
                                      type="submit"
                                      className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition"
                                  >
                                      Update Product
                                  </button>
                              </div>
                          </div>
                      </form>
                  </div>
              </div>
          );
      };

      const StockMovementModal = ({ product, type, quantity, notes, onQuantityChange, onNotesChange, onClose, onSubmit }) => {
          return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                  <div className="bg-white rounded-lg shadow-xl max-w-md w-full">
                      <div className="p-6 border-b">
                          <h2 className="text-xl font-bold">
                              Stock {type === 'in' ? 'IN' : 'OUT'}: {product.in_house_name || product.inHouseName}
                          </h2>
                          <p className="text-sm text-gray-600 mt-1">Code: {product.product_code || product.productCode}</p>
                          <p className="text-sm text-gray-600">Current Stock: {product.current_stock !== undefined ? product.current_stock : product.currentStock}</p>
                      </div>
                      <div className="p-6 space-y-4">
                          <div>
                              <label className="block text-sm font-medium mb-1">Quantity *</label>
                              <input
                                  type="number"
                                  required
                                  min="1"
                                  value={quantity}
                                  onChange={(e) => onQuantityChange(e.target.value)}
                                  className="w-full p-2 border rounded"
                                  autoFocus
                              />
                          </div>
                          <div>
                              <label className="block text-sm font-medium mb-1">Notes</label>
                              <textarea
                                  value={notes}
                                  onChange={(e) => onNotesChange(e.target.value)}
                                  className="w-full p-2 border rounded"
                                  rows="3"
                                  placeholder="Optional notes..."
                              />
                          </div>
                      </div>
                      <div className="p-6 border-t flex justify-end gap-2">
                          <button
                              onClick={onClose}
                              className="px-4 py-2 border rounded-lg hover:bg-gray-50 transition"
                          >
                              Cancel
                          </button>
                          <button
                              onClick={onSubmit}
                              disabled={!quantity}
                              className={`px-4 py-2 rounded-lg text-white transition ${
                                  type === 'in'
                                      ? 'bg-green-600 hover:bg-green-700'
                                      : 'bg-red-600 hover:bg-red-700'
                              } disabled:opacity-50 disabled:cursor-not-allowed`}
                          >
                              Confirm {type === 'in' ? 'Stock IN' : 'Stock OUT'}
                          </button>
                      </div>
                  </div>
              </div>
          );
      };

      const PartialReceiveModal = ({ orderItem, onClose, onSubmit }) => {
          const { item } = orderItem;
          const receivedQty = item.received_qty || 0;
          const orderedQty = parseInt(item.quantity);
          const remaining = orderedQty - receivedQty;
          const [quantity, setQuantity] = useState(remaining.toString());

          const handleSubmit = (e) => {
              e.preventDefault();
              const qty = parseInt(quantity);
              if (qty > 0 && qty <= remaining) {
                  onSubmit(qty);
              }
          };

          return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                  <div className="bg-white rounded-lg shadow-xl max-w-md w-full">
                      <div className="p-6 border-b">
                          <h2 className="text-xl font-bold">Receive Items</h2>
                          <p className="text-sm text-gray-600 mt-2">
                              <span className="font-medium">{item.productName}</span>
                          </p>
                          <p className="text-sm text-gray-600">Code: {item.productCode}</p>
                      </div>
                      <div className="p-6 space-y-4">
                          <div className="bg-gray-50 p-4 rounded-lg space-y-2">
                              <div className="flex justify-between text-sm">
                                  <span className="text-gray-600">Ordered:</span>
                                  <span className="font-medium">{orderedQty}</span>
                              </div>
                              <div className="flex justify-between text-sm">
                                  <span className="text-gray-600">Already Received:</span>
                                  <span className="font-medium text-green-600">{receivedQty}</span>
                              </div>
                              <div className="flex justify-between text-sm border-t pt-2">
                                  <span className="text-gray-600 font-medium">Remaining:</span>
                                  <span className="font-bold text-indigo-600">{remaining}</span>
                              </div>
                          </div>

                          <form onSubmit={handleSubmit}>
                              <label className="block text-sm font-medium mb-1">Quantity to Receive *</label>
                              <input
                                  type="number"
                                  required
                                  min="1"
                                  max={remaining}
                                  value={quantity}
                                  onChange={(e) => setQuantity(e.target.value)}
                                  className="w-full p-2 border rounded"
                                  autoFocus
                              />
                              <p className="text-xs text-gray-500 mt-1">
                                  Enter the quantity you are receiving now (max: {remaining})
                              </p>

                              <div className="flex justify-end gap-2 mt-6">
                                  <button
                                      type="button"
                                      onClick={onClose}
                                      className="px-4 py-2 border rounded-lg hover:bg-gray-50 transition"
                                  >
                                      Cancel
                                  </button>
                                  <button
                                      type="submit"
                                      disabled={!quantity || parseInt(quantity) <= 0 || parseInt(quantity) > remaining}
                                      className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
                                  >
                                      Receive {quantity || '0'} Items
                                  </button>
                              </div>
                          </form>
                      </div>
                  </div>
              </div>
          );
      };

      const OrderFormModal = ({ products, onClose, onSubmit }) => {
          const [formData, setFormData] = useState({
              supplier: 'MacFarlane',
              expected_date: '',
              notes: ''
          });
          const [orderItems, setOrderItems] = useState([]);
          const [selectedProduct, setSelectedProduct] = useState('');
          const [itemQuantity, setItemQuantity] = useState('');

          const addItemToOrder = () => {
              if (!selectedProduct || !itemQuantity) return;

              const product = products.find(p => p.id === parseInt(selectedProduct));
              if (!product) return;

              const newItem = {
                  productId: product.id,
                  productCode: product.product_code || product.productCode,
                  productName: product.in_house_name || product.inHouseName,
                  quantity: parseInt(itemQuantity)
              };

              setOrderItems([...orderItems, newItem]);
              setSelectedProduct('');
              setItemQuantity('');
          };

          const removeItem = (index) => {
              setOrderItems(orderItems.filter((_, i) => i !== index));
          };

          const handleSubmit = (e) => {
              e.preventDefault();
              if (orderItems.length === 0) {
                  alert('Please add at least one item to the order');
                  return;
              }
              onSubmit({
                  supplier: formData.supplier,
                  expectedDate: formData.expected_date,
                  notes: formData.notes,
                  items: orderItems
              });
          };

          return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                  <div className="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                      <div className="p-6 border-b sticky top-0 bg-white">
                          <h2 className="text-xl font-bold">Create New Order</h2>
                      </div>
                      <form onSubmit={handleSubmit} className="p-6 space-y-6">
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                              <div>
                                  <label className="block text-sm font-medium mb-1">Supplier *</label>
                                  <input
                                      type="text"
                                      required
                                      value={formData.supplier}
                                      onChange={(e) => setFormData({...formData, supplier: e.target.value})}
                                      className="w-full p-2 border rounded"
                                  />
                              </div>
                              <div>
                                  <label className="block text-sm font-medium mb-1">Expected Delivery Date *</label>
                                  <input
                                      type="date"
                                      required
                                      value={formData.expected_date}
                                      onChange={(e) => setFormData({...formData, expected_date: e.target.value})}
                                      className="w-full p-2 border rounded"
                                  />
                              </div>
                          </div>

                          <div>
                              <label className="block text-sm font-medium mb-1">Order Notes</label>
                              <textarea
                                  value={formData.notes}
                                  onChange={(e) => setFormData({...formData, notes: e.target.value})}
                                  className="w-full p-2 border rounded"
                                  rows="2"
                                  placeholder="Optional notes about this order..."
                              />
                          </div>

                          <div className="border-t pt-4">
                              <h3 className="font-semibold mb-3">Add Items to Order</h3>
                              <div className="flex gap-2 mb-4 flex-wrap">
                                  <select
                                      value={selectedProduct}
                                      onChange={(e) => setSelectedProduct(e.target.value)}
                                      className="flex-1 min-w-[200px] p-2 border rounded"
                                  >
                                      <option value="">Select a product...</option>
                                      {products.map(p => (
                                          <option key={p.id} value={p.id}>
                                              {p.product_code || p.productCode} - {p.in_house_name || p.inHouseName}
                                          </option>
                                      ))}
                                  </select>
                                  <input
                                      type="number"
                                      min="1"
                                      value={itemQuantity}
                                      onChange={(e) => setItemQuantity(e.target.value)}
                                      placeholder="Qty"
                                      className="w-24 p-2 border rounded"
                                  />
                                  <button
                                      type="button"
                                      onClick={addItemToOrder}
                                      className="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition"
                                  >
                                      Add
                                  </button>
                              </div>

                              {orderItems.length > 0 && (
                                  <div className="border rounded-lg overflow-hidden">
                                      <table className="w-full">
                                          <thead className="bg-gray-50">
                                              <tr>
                                                  <th className="px-4 py-2 text-left text-xs font-semibold text-gray-600">Code</th>
                                                  <th className="px-4 py-2 text-left text-xs font-semibold text-gray-600">Product</th>
                                                  <th className="px-4 py-2 text-left text-xs font-semibold text-gray-600">Quantity</th>
                                                  <th className="px-4 py-2 text-right text-xs font-semibold text-gray-600">Action</th>
                                              </tr>
                                          </thead>
                                          <tbody className="divide-y">
                                              {orderItems.map((item, idx) => (
                                                  <tr key={idx}>
                                                      <td className="px-4 py-2 text-sm">{item.productCode}</td>
                                                      <td className="px-4 py-2 text-sm">{item.productName}</td>
                                                      <td className="px-4 py-2 text-sm font-semibold">{item.quantity}</td>
                                                      <td className="px-4 py-2 text-right">
                                                          <button
                                                              type="button"
                                                              onClick={() => removeItem(idx)}
                                                              className="text-red-600 hover:text-red-700 text-sm"
                                                          >
                                                              Remove
                                                          </button>
                                                      </td>
                                                  </tr>
                                              ))}
                                          </tbody>
                                      </table>
                                  </div>
                              )}

                              {orderItems.length === 0 && (
                                  <div className="text-center py-8 text-gray-500 border rounded-lg">
                                      No items added yet. Select a product and quantity above.
                                  </div>
                              )}
                          </div>

                          <div className="flex justify-end gap-2 pt-4">
                              <button
                                  type="button"
                                  onClick={onClose}
                                  className="px-4 py-2 border rounded-lg hover:bg-gray-50 transition"
                              >
                                  Cancel
                              </button>
                              <button
                                  type="submit"
                                  disabled={orderItems.length === 0}
                                  className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
                              >
                                  Create Order ({orderItems.length} items)
                              </button>
                          </div>
                      </form>
                  </div>
              </div>
          );
      };

      ReactDOM.render(<PackagingStockApp />, document.getElementById('root'));
    </script>
  </body>
</html>
